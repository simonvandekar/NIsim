---
title: "Documentation for running pbj simulations on AWS"
author: "Simon Vandekar"
date: "2/7/2020"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval=FALSE)
path = Sys.getenv('PATH')
path = Sys.setenv('PATH'=paste(path, '/home/rstudio/.local/bin', sep=':'))
```

## AWS machine image setup

I use the directions [here](https://jagg19.github.io/2019/08/aws-r/#short-easy) to create an AMI to run Rstudio on.
The `Welcome.R` script in the [NIsim](https://github.com/simonvandekar/NIsim) package has code to setup this machine image with Dropbox access to the files.


## Setup simulations

```{r simconfig, eval=FALSE}
### LIBRARIES ###
library(RNifti)
library(parallel)
library(splines)
library(mmand)
library(fslr)
library(progress)
library(abind)
library(pbj)





### LOAD IN DATA FROM DROPBOX ###
dbimagedir = '~/Dropbox/pbj/data/abide/neuroimaging/cpac/alff'
dbresimagedir = '~/Dropbox/pbj/data/abide/neuroimaging/cpac/alff_resid'
dbdatafile = '~/Dropbox/pbj/data/abide/demographic/n1035_phenotypic_20190509.rds'
maskfile = '~/Dropbox/pbj/data/abide/neuroimaging/MNI152_T1_3mm.nii.gz'


# load in data and get directories
dat = readRDS(dbdatafile)
# fake covariates for later use if needed
dat$fake_covariate = rnorm(nrow(dat))
dat$fake_group = factor(sample(1:4, nrow(dat), replace=TRUE))
dat$imgname = paste(dat$file_id, 'alff.nii.gz', sep='_')
dat$files = file.path(dbimagedir, dat$imgname)



### COMPUTING PARAMETERS ###
computeConfig = list(
  # number of cores to use for computing
  ncores = parallel::detectCores()
)




### SIMULATION PARAMETERS ###
simConfig = list(
  # use robust variance estimator?
  robust = TRUE,
  # what transformation to use. Only the first is used
  tranform = c('t', 'edgeworth', 'none'),
  # vector of sample sizes to simulate
  ns = c(50, 100, 200, 400),
  # number of simulations to run
  nsim=3,
  # number of bootstraps
  nboot = 0,
  # number of permutations
  nperm = 0,
  # cluster forming thresholds
  cfts.s = c(0.1, 0.25, 0.4),
  cfts.p = c(0.05, 0.01, 0.005, 0.001),
  
  # radius for spheres of signal.
  rs=c(8),
  
  #### MODEL FORMULAS FOR SIMULATIONS ####
  formres = as.formula( paste0(" ~ dx_group + sex + func_mean_fd + ns(age_at_scan, df=10)" )),
  # need age_at_scan in both models for testing nonlinear functions
  form = as.formula(paste0(" ~ sex + func_mean_fd + age_at_scan + scale(age_at_scan^2) + scale(age_at_scan^3)" )),
  formred = as.formula(paste0(" ~ sex + func_mean_fd + age_at_scan")),
  #  weights for each subject. Can be a character vector
  W = c("func_mean_fd"),
  # where to output results
  outdir = '~/spline_nullsim',
  dat = dat,
  mask = maskfile
)
# use betas = 0 for global null
# parameters = betas * sd(y)/sd(x).
simConfig$betas = rep(0, length(simConfig$rs))
```
```{r simsetup}
### SETUP THE SIMULATION ANALYSIS ###
# subsets dataset to all people who have the variables
simConfig$dat = simConfig$dat[apply(!is.na(simConfig$dat[ ,c(all.vars(as.formula(simConfig$formres)), simConfig$W)]), 1, all), ]
# Create residualized images
if(class(simConfig$formres)=='formula' | is.character(simConfig$formres)){
  simConfig$dat$rfiles = file.path(tempdir(), 'res_images', basename(simConfig$dat$files))
  if(!all(file.exists(simConfig$dat$rfiles))){
  pbj::residualizeImages(files=simConfig$dat$files, dat=simConfig$dat, mask=simConfig$mask, form=simConfig$formres,
                         outfiles=simConfig$dat$rfiles, mc.cores=computeConfig$ncores)
}
  simConfig$dat$files = simConfig$dat$rfiles
  # clean up. May not be necessary
  gc()
}


devtools::load_all('./')
simdirs = simSetup(simConfig$dat$files, data=simConfig$dat, outdir=simConfig$outdir, nsim=simConfig$nsim, ns=simConfig$ns, mask=simConfig$mask, rs=simConfig$rs, betas=simConfig$betas )

# simfunc should contain a data argument, which is defined within runSim
# Other arguments are identical across simulation runs.
simFunc = function(lmfull, lmred, mask, data){
  lmPBJ(data$images, form=lmfull, formred=lmred, mask=mask, data=data, transform = 't')$stat
}
simres = runSim(simdirs$simdir[1:2],
       simfunc = simFunc, mask = simConfig$mask,
simfuncArgs = list(
  lmfull= simConfig$form,
  lmred = simConfig$formred,
  mask = simConfig$mask)
)


```

